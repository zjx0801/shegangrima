<!DOCTYPE html><html lang="zh-CN"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>社港日麻数据统计系统</title>    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>    <style>        :root {            --primary-color: #4a6fa5;            --secondary-color: #6b8cbc;            --accent-color: #ff6b6b;            --light-color: #f5f7fa;            --dark-color: #2c3e50;            --success-color: #4caf50;            --warning-color: #ff9800;            --danger-color: #f44336;            --border-radius: 8px;            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);        }                * {            box-sizing: border-box;            margin: 0;            padding: 0;            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;        }                body {            background-color: #f0f2f5;            color: var(--dark-color);            line-height: 1.6;            padding-bottom: 60px;        }                header {            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));            color: white;            padding: 1rem;            text-align: center;            box-shadow: var(--box-shadow);            position: sticky;            top: 0;            z-index: 100;        }                h1 {            font-size: 1.5rem;            margin-bottom: 0.5rem;        }                .subtitle {            font-size: 0.9rem;            opacity: 0.9;        }                nav {            display: flex;            background-color: white;            border-bottom: 1px solid #e0e0e0;            position: sticky;            top: 80px;            z-index: 99;        }                .nav-btn {            flex: 1;            padding: 12px 0;            background: none;            border: none;            font-size: 0.9rem;            color: var(--dark-color);            cursor: pointer;            transition: all 0.3s ease;        }                .nav-btn.active {            color: var(--primary-color);            border-bottom: 3px solid var(--primary-color);            font-weight: bold;        }                .container {            max-width: 1000px;            margin: 0 auto;            padding: 1rem;        }                .tab-content {            display: none;            animation: fadeIn 0.5s ease;        }                .tab-content.active {            display: block;        }                @keyframes fadeIn {            from { opacity: 0; }            to { opacity: 1; }        }                .card {            background-color: white;            border-radius: var(--border-radius);            box-shadow: var(--box-shadow);            padding: 1.5rem;            margin-bottom: 1.5rem;        }                .card-title {            font-size: 1.2rem;            margin-bottom: 1rem;            color: var(--primary-color);            border-bottom: 1px solid #e0e0e0;            padding-bottom: 0.5rem;        }                .form-group {            margin-bottom: 1rem;        }                label {            display: block;            margin-bottom: 0.5rem;            font-weight: 500;        }                input, select {            width: 100%;            padding: 12px;            border: 1px solid #ddd;            border-radius: var(--border-radius);            font-size: 1rem;            transition: border 0.3s ease;        }                input:focus, select:focus {            outline: none;            border-color: var(--primary-color);            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);        }                .players-container {            display: grid;            grid-template-columns: 1fr 1fr;            gap: 1rem;            margin-bottom: 1rem;        }                .rankings-container {            display: grid;            grid-template-columns: 1fr 1fr;            gap: 1rem;        }                .btn-group {            display: flex;            gap: 0.5rem;            margin-bottom: 1rem;            flex-wrap: wrap;        }                .btn {            padding: 10px 16px;            border: none;            border-radius: var(--border-radius);            font-size: 0.9rem;            cursor: pointer;            transition: all 0.3s ease;            display: flex;            align-items: center;            justify-content: center;            gap: 5px;        }                .btn-primary {            background-color: var(--primary-color);            color: white;        }                .btn-secondary {            background-color: #e0e0e0;            color: var(--dark-color);        }                .btn-success {            background-color: var(--success-color);            color: white;        }                .btn-warning {            background-color: var(--warning-color);            color: white;        }                .btn-danger {            background-color: var(--danger-color);            color: white;        }                .btn:hover {            opacity: 0.9;            transform: translateY(-2px);        }                .win-record, .draw-record {            border: 1px solid #e0e0e0;            border-radius: var(--border-radius);            padding: 1rem;            margin-bottom: 1rem;            background-color: #f9f9f9;        }                .win-record-header, .draw-record-header {            display: flex;            justify-content: space-between;            align-items: center;            margin-bottom: 1rem;        }                .win-record-title, .draw-record-title {            font-weight: bold;            color: var(--primary-color);        }                .remove-record {            background: none;            border: none;            color: var(--danger-color);            cursor: pointer;            font-size: 1.2rem;        }                .player-checkboxes {            display: grid;            grid-template-columns: 1fr 1fr;            gap: 0.5rem;            margin-top: 0.5rem;        }                .checkbox-group {            display: flex;            align-items: center;            gap: 0.5rem;        }                .history-item {            border: 1px solid #e0e0e0;            border-radius: var(--border-radius);            padding: 1rem;            margin-bottom: 1rem;            background-color: white;        }                .history-header {            display: flex;            justify-content: space-between;            margin-bottom: 0.5rem;        }                .history-date {            font-weight: bold;            color: var(--primary-color);        }                .history-rankings {            display: flex;            justify-content: space-between;            margin-bottom: 0.5rem;        }                .ranking-item {            text-align: center;            flex: 1;        }                .ranking-position {            font-weight: bold;            font-size: 1.1rem;        }                .first { color: #ffc107; }        .second { color: #6c757d; }        .third { color: #cd7f32; }        .fourth { color: #dc3545; }                .stats-grid {            display: grid;            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));            gap: 1.5rem;        }                .player-card {            background-color: white;            border-radius: var(--border-radius);            box-shadow: var(--box-shadow);            padding: 1.5rem;            transition: transform 0.3s ease;        }                .player-card:hover {            transform: translateY(-5px);        }                .player-name {            font-size: 1.3rem;            font-weight: bold;            color: var(--primary-color);            margin-bottom: 1rem;            text-align: center;            padding-bottom: 0.5rem;            border-bottom: 1px solid #e0e0e0;        }                .stat-item {            display: flex;            justify-content: space-between;            margin-bottom: 0.8rem;            padding-bottom: 0.5rem;            border-bottom: 1px dashed #e0e0e0;        }                .stat-label {            font-weight: 500;        }                .stat-value {            font-weight: bold;            color: var(--dark-color);        }                .export-options {            display: grid;            grid-template-columns: 1fr;            gap: 1rem;        }                .export-card {            background-color: white;            border-radius: var(--border-radius);            box-shadow: var(--box-shadow);            padding: 1.5rem;            text-align: center;        }                .export-icon {            font-size: 2.5rem;            margin-bottom: 1rem;            color: var(--primary-color);        }                .export-description {            margin-bottom: 1.5rem;            color: #666;        }                .empty-state {            text-align: center;            padding: 2rem;            color: #666;        }                .empty-icon {            font-size: 3rem;            margin-bottom: 1rem;            color: #ccc;        }                .chart-container {            background-color: white;            border-radius: var(--border-radius);            box-shadow: var(--box-shadow);            padding: 1.5rem;            margin-bottom: 1.5rem;        }                .chart-title {            font-size: 1.2rem;            margin-bottom: 1rem;            color: var(--primary-color);            border-bottom: 1px solid #e0e0e0;            padding-bottom: 0.5rem;        }                .charts-grid {            display: grid;            grid-template-columns: 1fr;            gap: 1.5rem;        }                @media (min-width: 768px) {            .charts-grid {                grid-template-columns: 1fr 1fr;            }        }                @media (max-width: 768px) {            .players-container, .rankings-container, .player-checkboxes {                grid-template-columns: 1fr;            }                        .stats-grid {                grid-template-columns: 1fr;            }                        .btn-group {                flex-direction: column;            }                        .btn {                width: 100%;            }        }                .toast {            position: fixed;            bottom: 20px;            left: 50%;            transform: translateX(-50%);            background-color: var(--dark-color);            color: white;            padding: 12px 24px;            border-radius: var(--border-radius);            box-shadow: var(--box-shadow);            z-index: 1000;            opacity: 0;            transition: opacity 0.3s ease;        }                .toast.show {            opacity: 1;        }                .error-message {            color: var(--danger-color);            font-size: 0.8rem;            margin-top: 0.25rem;        }                .input-error {            border-color: var(--danger-color);        }                .data-status {            text-align: center;            padding: 0.5rem;            margin-bottom: 1rem;            border-radius: var(--border-radius);            font-size: 0.9rem;        }                .data-status.saving {            background-color: #e8f5e8;            color: var(--success-color);        }                .data-status.error {            background-color: #ffebee;            color: var(--danger-color);        }    </style></head><body>    <header>        <h1>社港日麻数据统计系统</h1>        <div class="subtitle">线下日麻社团数据统计与分析工具</div>    </header>        <nav>        <button class="nav-btn active" data-tab="record">对局记录</button>        <button class="nav-btn" data-tab="stats">数据统计</button>        <button class="nav-btn" data-tab="charts">统计图表</button>        <button class="nav-btn" data-tab="export">数据导出</button>    </nav>        <div class="container">        <!-- 数据状态指示器 -->        <div id="data-status" class="data-status" style="display: none;"></div>                <!-- 对局记录页 -->        <section id="record" class="tab-content active">            <div class="card">                <h2 class="card-title">新对局记录</h2>                                <div class="form-group">                    <label for="game-date">日期</label>                    <input type="date" id="game-date" required>                    <div class="error-message" id="date-error"></div>                </div>                                <div class="form-group">                    <label>玩家信息</label>                    <div class="players-container">                        <div class="form-group">                            <input type="text" id="player1" placeholder="玩家1" required>                            <div class="error-message" id="player1-error"></div>                        </div>                        <div class="form-group">                            <input type="text" id="player2" placeholder="玩家2" required>                            <div class="error-message" id="player2-error"></div>                        </div>                        <div class="form-group">                            <input type="text" id="player3" placeholder="玩家3" required>                            <div class="error-message" id="player3-error"></div>                        </div>                        <div class="form-group">                            <input type="text" id="player4" placeholder="玩家4" required>                            <div class="error-message" id="player4-error"></div>                        </div>                    </div>                </div>                                <div class="btn-group">                    <button type="button" class="btn btn-secondary" id="update-players">                        <span>??</span> 更新玩家列表                    </button>                    <button type="button" class="btn btn-secondary" id="copy-last-game">                        <span>??</span> 复制上局玩家                    </button>                    <button type="button" class="btn btn-secondary" id="clear-players">                        <span>?</span> 清空玩家                    </button>                </div>                                <div class="form-group">                    <label>顺位选择</label>                    <div class="rankings-container">                        <div class="form-group">                            <label for="first-place">一位</label>                            <select id="first-place" required>                                <option value="">请选择一位玩家</option>                            </select>                            <div class="error-message" id="first-place-error"></div>                        </div>                        <div class="form-group">                            <label for="second-place">二位</label>                            <select id="second-place" required>                                <option value="">请选择二位玩家</option>                            </select>                            <div class="error-message" id="second-place-error"></div>                        </div>                        <div class="form-group">                            <label for="third-place">三位</label>                            <select id="third-place" required>                                <option value="">请选择三位玩家</option>                            </select>                            <div class="error-message" id="third-place-error"></div>                        </div>                        <div class="form-group">                            <label for="fourth-place">四位</label>                            <select id="fourth-place" required>                                <option value="">请选择四位玩家</option>                            </select>                            <div class="error-message" id="fourth-place-error"></div>                        </div>                    </div>                </div>                                <div class="form-group">                    <div class="win-record-header">                        <h3 class="win-record-title">和牌记录</h3>                        <button type="button" class="btn btn-primary" id="add-win-record">                            <span>?</span> 添加和牌记录                        </button>                    </div>                    <div id="win-records-container">                        <!-- 动态添加的和牌记录 -->                    </div>                </div>                                <div class="form-group">                    <div class="draw-record-header">                        <h3 class="draw-record-title">流局记录</h3>                        <button type="button" class="btn btn-primary" id="add-draw-record">                            <span>?</span> 添加流局记录                        </button>                    </div>                    <div id="draw-records-container">                        <!-- 动态添加的流局记录 -->                    </div>                </div>                                <div class="btn-group">                    <button type="button" class="btn btn-success" id="save-game">                        <span>??</span> 保存对局                    </button>                    <button type="button" class="btn btn-secondary" id="clear-form">                        <span>???</span> 清空表单                    </button>                </div>            </div>                        <div class="card">                <h2 class="card-title">历史对局</h2>                <div id="history-list">                    <!-- 动态添加的历史对局 -->                </div>            </div>        </section>                <!-- 数据统计页 -->        <section id="stats" class="tab-content">            <div class="card">                <h2 class="card-title">玩家统计数据</h2>                <div id="stats-container" class="stats-grid">                    <!-- 动态生成的玩家统计卡片 -->                </div>            </div>        </section>                <!-- 统计图表页 -->        <section id="charts" class="tab-content">            <div class="card">                <h2 class="card-title">数据可视化</h2>                <div class="charts-grid">                    <div class="chart-container">                        <h3 class="chart-title">平均顺位</h3>                        <canvas id="average-rank-chart"></canvas>                    </div>                    <div class="chart-container">                        <h3 class="chart-title">和牌率对比</h3>                        <canvas id="win-rate-chart"></canvas>                    </div>                    <div class="chart-container">                        <h3 class="chart-title">放铳率对比</h3>                        <canvas id="deal-in-rate-chart"></canvas>                    </div>                    <div class="chart-container">                        <h3 class="chart-title">平均打点</h3>                        <canvas id="average-points-chart"></canvas>                    </div>                </div>            </div>        </section>                <!-- 数据导出页 -->        <section id="export" class="tab-content">            <div class="card">                <h2 class="card-title">数据导出与备份</h2>                <div class="export-options">                    <div class="export-card">                        <div class="export-icon">??</div>                        <h3>Excel导出</h3>                        <p class="export-description">导出完整数据到Excel文件，包含对局记录、和牌记录和玩家统计三个工作表</p>                        <button class="btn btn-primary" id="export-excel">                            <span>??</span> 导出Excel                        </button>                    </div>                                        <div class="export-card">                        <div class="export-icon">??</div>                        <h3>数据备份</h3>                        <p class="export-description">将数据备份为JSON文件，可用于数据恢复或迁移</p>                        <div class="btn-group">                            <button class="btn btn-secondary" id="export-json">                                <span>??</span> 导出JSON                            </button>                            <button class="btn btn-secondary" id="import-json">                                <span>??</span> 导入JSON                            </button>                        </div>                    </div>                                        <div class="export-card">                        <div class="export-icon">??</div>                        <h3>数据管理</h3>                        <p class="export-description">清空所有数据，操作不可逆，请谨慎使用</p>                        <button class="btn btn-danger" id="clear-data">                            <span>???</span> 清空所有数据                        </button>                    </div>                </div>            </div>        </section>    </div>        <div class="toast" id="toast"></div>        <script>        // 数据存储键名        const STORAGE_KEY = 'mahjong_games';                // 全局数据        let games = [];        let players = [];                // DOM元素        const tabContents = document.querySelectorAll('.tab-content');        const navBtns = document.querySelectorAll('.nav-btn');        const playerInputs = [            document.getElementById('player1'),            document.getElementById('player2'),            document.getElementById('player3'),            document.getElementById('player4')        ];        const rankingSelects = [            document.getElementById('first-place'),            document.getElementById('second-place'),            document.getElementById('third-place'),            document.getElementById('fourth-place')        ];        const winRecordsContainer = document.getElementById('win-records-container');        const drawRecordsContainer = document.getElementById('draw-records-container');        const historyList = document.getElementById('history-list');        const statsContainer = document.getElementById('stats-container');        const toast = document.getElementById('toast');        const dataStatus = document.getElementById('data-status');                // 图表实例        let averageRankChart, winRateChart, dealInRateChart, averagePointsChart;                // 初始化        document.addEventListener('DOMContentLoaded', function() {            loadData();            setupEventListeners();            updatePlayerOptions();            renderHistory();            renderStats();                        // 设置默认日期为今天            const today = new Date().toISOString().split('T')[0];            document.getElementById('game-date').value = today;                        // 显示数据状态            showDataStatus(`已加载 ${games.length} 条对局记录`, 'saving');            setTimeout(() => {                hideDataStatus();            }, 3000);        });                // 显示数据状态        function showDataStatus(message, type) {            dataStatus.textContent = message;            dataStatus.className = `data-status ${type}`;            dataStatus.style.display = 'block';        }                // 隐藏数据状态        function hideDataStatus() {            dataStatus.style.display = 'none';        }                // 设置事件监听器        function setupEventListeners() {            // 标签页切换            navBtns.forEach(btn => {                btn.addEventListener('click', function() {                    const tabId = this.getAttribute('data-tab');                                        // 更新活动标签页                    navBtns.forEach(b => b.classList.remove('active'));                    tabContents.forEach(tab => tab.classList.remove('active'));                                        this.classList.add('active');                    document.getElementById(tabId).classList.add('active');                                        // 如果切换到统计页，更新统计数据                    if (tabId === 'stats') {                        renderStats();                    }                                        // 如果切换到图表页，更新图表                    if (tabId === 'charts') {                        renderCharts();                    }                });            });                        // 更新玩家列表            document.getElementById('update-players').addEventListener('click', updatePlayerOptions);                        // 复制上局玩家            document.getElementById('copy-last-game').addEventListener('click', copyLastGamePlayers);                        // 清空玩家            document.getElementById('clear-players').addEventListener('click', clearPlayers);                        // 添加和牌记录            document.getElementById('add-win-record').addEventListener('click', addWinRecord);                        // 添加流局记录            document.getElementById('add-draw-record').addEventListener('click', addDrawRecord);                        // 保存对局            document.getElementById('save-game').addEventListener('click', saveGame);                        // 清空表单            document.getElementById('clear-form').addEventListener('click', clearForm);                        // 导出功能            document.getElementById('export-excel').addEventListener('click', exportToExcel);            document.getElementById('export-json').addEventListener('click', exportToJSON);            document.getElementById('import-json').addEventListener('click', importFromJSON);            document.getElementById('clear-data').addEventListener('click', clearAllData);                        // 玩家输入变化时更新下拉选项            playerInputs.forEach(input => {                input.addEventListener('input', updatePlayerOptions);            });                        // 玩家输入变化时检查重复            playerInputs.forEach(input => {                input.addEventListener('input', checkDuplicatePlayers);            });                        // 页面可见性变化时保存数据（防止数据丢失）            document.addEventListener('visibilitychange', function() {                if (document.visibilityState === 'hidden') {                    saveData();                }            });                        // 页面卸载前保存数据            window.addEventListener('beforeunload', function() {                saveData();            });                        // 定期自动保存数据（每30秒）            setInterval(function() {                if (games.length > 0) {                    saveData();                    showDataStatus('数据已自动保存', 'saving');                    setTimeout(() => {                        hideDataStatus();                    }, 2000);                }            }, 30000);        }                // 加载数据        function loadData() {            try {                const storedGames = localStorage.getItem(STORAGE_KEY);                if (storedGames) {                    games = JSON.parse(storedGames);                    console.log(`成功加载 ${games.length} 条对局记录`);                } else {                    console.log('没有找到存储的数据');                }            } catch (error) {                console.error('加载数据失败:', error);                showDataStatus('加载数据失败，将使用空数据', 'error');                games = [];            }                        // 提取所有玩家            updatePlayersFromGames();        }                // 从游戏记录中提取玩家        function updatePlayersFromGames() {            const playerSet = new Set();                        games.forEach(game => {                game.players.forEach(player => {                    if (player && player.trim() !== '') {                        playerSet.add(player);                    }                });                                if (game.winRecords) {                    game.winRecords.forEach(record => {                        if (record.winner) playerSet.add(record.winner);                        if (record.loser && record.loser !== '无') playerSet.add(record.loser);                    });                }            });                        players = Array.from(playerSet).sort();        }                // 保存数据        function saveData() {            try {                localStorage.setItem(STORAGE_KEY, JSON.stringify(games));                updatePlayersFromGames();                console.log(`数据保存成功，当前有 ${games.length} 条对局记录`);                return true;            } catch (error) {                console.error('保存数据失败:', error);                showDataStatus('保存数据失败，请尝试导出备份', 'error');                return false;            }        }                // 检查玩家姓名重复        function checkDuplicatePlayers() {            const playerNames = playerInputs.map(input => input.value.trim()).filter(name => name !== '');            const uniqueNames = new Set(playerNames);                        // 清除之前的错误状态            playerInputs.forEach(input => {                input.classList.remove('input-error');                const errorElement = document.getElementById(`${input.id}-error`);                if (errorElement) errorElement.textContent = '';            });                        // 检查重复            if (playerNames.length > uniqueNames.size) {                // 找到重复的玩家                const duplicates = playerNames.filter((name, index) => playerNames.indexOf(name) !== index);                                // 标记重复的输入框                playerInputs.forEach(input => {                    if (duplicates.includes(input.value.trim())) {                        input.classList.add('input-error');                        const errorElement = document.getElementById(`${input.id}-error`);                        if (errorElement) errorElement.textContent = '玩家姓名不能重复';                    }                });                                return false;            }                        return true;        }                // 验证表单数据        function validateForm() {            let isValid = true;                        // 清除之前的错误状态            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));                        // 不再检查日期是否为未来日期            // 允许设置未来日期                        // 检查玩家姓名            if (!checkDuplicatePlayers()) {                isValid = false;            }                        // 检查玩家是否填写完整            const playerNames = playerInputs.map(input => input.value.trim());            if (playerNames.some(name => !name)) {                playerInputs.forEach((input, index) => {                    if (!input.value.trim()) {                        document.getElementById(`${input.id}-error`).textContent = '玩家姓名不能为空';                        input.classList.add('input-error');                    }                });                isValid = false;            }                        // 检查顺位选择            const rankingValues = rankingSelects.map(select => select.value);            const uniqueRankings = new Set(rankingValues);                        if (uniqueRankings.size !== 4 || rankingValues.some(player => !player)) {                rankingSelects.forEach(select => {                    if (!select.value) {                        document.getElementById(`${select.id}-error`).textContent = '请选择顺位';                        select.classList.add('input-error');                    }                });                isValid = false;            }                        // 检查和牌记录            const winRecordElements = document.querySelectorAll('.win-record');            winRecordElements.forEach(recordElement => {                const winType = recordElement.querySelector('.win-type').value;                const tenpaiType = recordElement.querySelector('.tenpai-type').value;                const winner = recordElement.querySelector('.winner-select').value;                const points = parseInt(recordElement.querySelector('.points').value) || 0;                                if ((winType || tenpaiType || winner || points > 0) &&                     (!winType || !tenpaiType || !winner || points <= 0)) {                    showToast('请完整填写和牌记录或删除不完整的记录');                    isValid = false;                }            });                        return isValid;        }                // 获取当前玩家列表        function getCurrentPlayers() {            return playerInputs                .map(input => input.value.trim())                .filter(name => name !== '');        }                // 更新玩家下拉选项        function updatePlayerOptions() {            // 从输入框获取当前玩家            const currentPlayers = getCurrentPlayers();                        // 合并当前玩家和历史玩家            const allPlayers = [...new Set([...currentPlayers, ...players])].sort();                        // 更新所有下拉选择框            rankingSelects.forEach(select => {                const currentValue = select.value;                select.innerHTML = '<option value="">请选择玩家</option>';                                allPlayers.forEach(player => {                    const option = document.createElement('option');                    option.value = player;                    option.textContent = player;                    select.appendChild(option);                });                                // 恢复之前的选择                if (allPlayers.includes(currentValue)) {                    select.value = currentValue;                }            });                        // 更新和牌记录中的下拉框            document.querySelectorAll('.winner-select, .loser-select').forEach(select => {                const currentValue = select.value;                select.innerHTML = '<option value="">请选择玩家</option>';                                allPlayers.forEach(player => {                    const option = document.createElement('option');                    option.value = player;                    option.textContent = player;                    select.appendChild(option);                });                                // 恢复之前的选择                if (allPlayers.includes(currentValue)) {                    select.value = currentValue;                }            });                        // 更新和牌记录和流局记录中的复选框标签            document.querySelectorAll('.player-checkboxes').forEach(container => {                const checkboxes = container.querySelectorAll('input[type="checkbox"]');                const labels = container.querySelectorAll('label');                                checkboxes.forEach((checkbox, index) => {                    if (index < currentPlayers.length) {                        checkbox.value = currentPlayers[index];                        labels[index].textContent = currentPlayers[index];                        checkbox.disabled = false;                        checkbox.style.display = 'block';                        labels[index].style.display = 'block';                    } else {                        // 如果玩家不足4个，隐藏多余的复选框                        checkbox.disabled = true;                        checkbox.style.display = 'none';                        labels[index].style.display = 'none';                    }                });            });        }                // 复制上局玩家        function copyLastGamePlayers() {            if (games.length === 0) {                showToast('没有历史对局数据');                return;            }                        const lastGame = games[games.length - 1];            playerInputs.forEach((input, index) => {                if (index < lastGame.players.length) {                    input.value = lastGame.players[index];                }            });                        updatePlayerOptions();            showToast('已复制上局玩家信息');        }                // 清空玩家        function clearPlayers() {            playerInputs.forEach(input => {                input.value = '';            });                        updatePlayerOptions();            showToast('已清空玩家信息');        }                // 创建玩家复选框HTML        function createPlayerCheckboxesHTML(prefix, recordId) {            const currentPlayers = getCurrentPlayers();            let html = '';                        currentPlayers.forEach((player, index) => {                html += `                    <div class="checkbox-group">                        <input type="checkbox" id="${prefix}-${recordId}-${index}" value="${player}">                        <label for="${prefix}-${recordId}-${index}">${player}</label>                    </div>                `;            });                        // 如果玩家不足4个，添加隐藏的占位符以保持布局            for (let i = currentPlayers.length; i < 4; i++) {                html += `                    <div class="checkbox-group" style="display: none;">                        <input type="checkbox" id="${prefix}-${recordId}-${i}" value="" disabled>                        <label for="${prefix}-${recordId}-${i}">玩家${i+1}</label>                    </div>                `;            }                        return html;        }                // 添加和牌记录 - 修改为新记录放在最上方        function addWinRecord() {            const recordId = Date.now();            const currentPlayers = getCurrentPlayers();                        if (currentPlayers.length === 0) {                showToast('请先输入玩家信息');                return;            }                        const recordElement = document.createElement('div');            recordElement.className = 'win-record';            recordElement.innerHTML = `                <div class="win-record-header">                    <div class="win-record-title">和牌记录</div>                    <button type="button" class="remove-record" data-id="${recordId}">×</button>                </div>                <div class="form-group">                    <label for="win-type-${recordId}">和牌类型</label>                    <select id="win-type-${recordId}" class="win-type" required>                        <option value="">请选择和牌类型</option>                        <option value="自摸">自摸</option>                        <option value="荣和">荣和</option>                    </select>                </div>                <div class="form-group">                    <label for="tenpai-type-${recordId}">听牌方式</label>                    <select id="tenpai-type-${recordId}" class="tenpai-type" required>                        <option value="">请选择听牌方式</option>                        <option value="立直">立直</option>                        <option value="默听">默听</option>                        <option value="副露听">副露听</option>                    </select>                </div>                <div class="form-group">                    <label for="winner-${recordId}">和牌者</label>                    <select id="winner-${recordId}" class="winner-select" required>                        <option value="">请选择和牌者</option>                        ${currentPlayers.map(player => `<option value="${player}">${player}</option>`).join('')}                    </select>                </div>                <div class="form-group">                    <label for="loser-${recordId}">放铳者</label>                    <select id="loser-${recordId}" class="loser-select">                        <option value="无">无</option>                        ${currentPlayers.map(player => `<option value="${player}">${player}</option>`).join('')}                    </select>                </div>                <div class="form-group">                    <label for="points-${recordId}">点数</label>                    <input type="number" id="points-${recordId}" class="points" min="0" required>                </div>                <div class="form-group">                    <label>立直玩家</label>                    <div class="player-checkboxes">                        ${createPlayerCheckboxesHTML('riichi', recordId)}                    </div>                </div>                <div class="form-group">                    <label>副露玩家</label>                    <div class="player-checkboxes">                        ${createPlayerCheckboxesHTML('furo', recordId)}                    </div>                </div>            `;                        // 将新记录插入到最上方            winRecordsContainer.insertBefore(recordElement, winRecordsContainer.firstChild);                        // 添加删除记录的事件监听            recordElement.querySelector('.remove-record').addEventListener('click', function() {                this.closest('.win-record').remove();            });                        // 根据和牌类型显示/隐藏放铳者            const winTypeSelect = recordElement.querySelector('.win-type');            const loserSelect = recordElement.querySelector('.loser-select');                        winTypeSelect.addEventListener('change', function() {                if (this.value === '自摸') {                    loserSelect.value = '无';                    loserSelect.disabled = true;                } else {                    loserSelect.disabled = false;                }            });                        // 自动聚焦到第一个输入框            setTimeout(() => {                const firstInput = recordElement.querySelector('.win-type');                if (firstInput) firstInput.focus();            }, 100);        }                // 添加流局记录 - 修改为新记录放在最上方        function addDrawRecord() {            const recordId = Date.now();            const currentPlayers = getCurrentPlayers();                        if (currentPlayers.length === 0) {                showToast('请先输入玩家信息');                return;            }                        const recordElement = document.createElement('div');            recordElement.className = 'draw-record';            recordElement.innerHTML = `                <div class="draw-record-header">                    <div class="draw-record-title">流局记录</div>                    <button type="button" class="remove-record" data-id="${recordId}">×</button>                </div>                <div class="form-group">                    <label for="draw-type-${recordId}">流局类型</label>                    <select id="draw-type-${recordId}" class="draw-type" required>                        <option value="">请选择流局类型</option>                        <option value="荒牌流局">荒牌流局</option>                        <option value="四风连打">四风连打</option>                        <option value="四家立直">四家立直</option>                        <option value="四杠散了">四杠散了</option>                        <option value="九种九牌">九种九牌</option>                    </select>                </div>                <div class="form-group">                    <label>听牌玩家</label>                    <div class="player-checkboxes">                        ${createPlayerCheckboxesHTML('tenpai', recordId)}                    </div>                </div>                <div class="form-group">                    <label>立直玩家</label>                    <div class="player-checkboxes">                        ${createPlayerCheckboxesHTML('draw-riichi', recordId)}                    </div>                </div>                <div class="form-group">                    <label>副露玩家</label>                    <div class="player-checkboxes">                        ${createPlayerCheckboxesHTML('draw-furo', recordId)}                    </div>                </div>            `;                        // 将新记录插入到最上方            drawRecordsContainer.insertBefore(recordElement, drawRecordsContainer.firstChild);                        // 添加删除记录的事件监听            recordElement.querySelector('.remove-record').addEventListener('click', function() {                this.closest('.draw-record').remove();            });                        // 自动聚焦到第一个输入框            setTimeout(() => {                const firstInput = recordElement.querySelector('.draw-type');                if (firstInput) firstInput.focus();            }, 100);        }                // 保存对局        function saveGame() {            // 验证表单数据            if (!validateForm()) {                showToast('请检查表单数据是否正确');                return;            }                        // 获取表单数据            const date = document.getElementById('game-date').value;                        const players = playerInputs.map(input => input.value.trim()).filter(name => name !== '');                        if (players.length !== 4) {                showToast('请输入4位玩家姓名');                return;            }                        const rankings = {                first: document.getElementById('first-place').value,                second: document.getElementById('second-place').value,                third: document.getElementById('third-place').value,                fourth: document.getElementById('fourth-place').value            };                        // 检查顺位选择是否有效            const rankingPlayers = Object.values(rankings);            const uniqueRankings = new Set(rankingPlayers);                        if (uniqueRankings.size !== 4 || rankingPlayers.some(player => !player)) {                showToast('请为每位玩家选择不同的顺位');                return;            }                        // 获取和牌记录            const winRecords = [];            const winRecordElements = document.querySelectorAll('.win-record');                        winRecordElements.forEach(recordElement => {                const winType = recordElement.querySelector('.win-type').value;                const tenpaiType = recordElement.querySelector('.tenpai-type').value;                const winner = recordElement.querySelector('.winner-select').value;                const loser = recordElement.querySelector('.loser-select').value;                const points = parseInt(recordElement.querySelector('.points').value) || 0;                                // 获取立直玩家                const riichiCheckboxes = recordElement.querySelectorAll('input[type="checkbox"][id^="riichi"]');                const riichiPlayers = Array.from(riichiCheckboxes)                    .filter(cb => cb.checked && !cb.disabled)                    .map(cb => cb.value);                                // 获取副露玩家                const furoCheckboxes = recordElement.querySelectorAll('input[type="checkbox"][id^="furo"]');                const furoPlayers = Array.from(furoCheckboxes)                    .filter(cb => cb.checked && !cb.disabled)                    .map(cb => cb.value);                                if (winType && tenpaiType && winner && points > 0) {                    winRecords.push({                        type: winType,                        tenpaiType: tenpaiType,                        winner: winner,                        loser: loser === '无' ? null : loser,                        points: points,                        riichiPlayers: riichiPlayers,                        furoPlayers: furoPlayers                    });                }            });                        // 获取流局记录            const drawRecords = [];            const drawRecordElements = document.querySelectorAll('.draw-record');                        drawRecordElements.forEach(recordElement => {                const drawType = recordElement.querySelector('.draw-type').value;                                // 获取听牌玩家                const tenpaiCheckboxes = recordElement.querySelectorAll('input[type="checkbox"][id^="tenpai"]');                const tenpaiPlayers = Array.from(tenpaiCheckboxes)                    .filter(cb => cb.checked && !cb.disabled)                    .map(cb => cb.value);                                // 获取立直玩家                const riichiCheckboxes = recordElement.querySelectorAll('input[type="checkbox"][id^="draw-riichi"]');                const riichiPlayers = Array.from(riichiCheckboxes)                    .filter(cb => cb.checked && !cb.disabled)                    .map(cb => cb.value);                                // 获取副露玩家                const furoCheckboxes = recordElement.querySelectorAll('input[type="checkbox"][id^="draw-furo"]');                const furoPlayers = Array.from(furoCheckboxes)                    .filter(cb => cb.checked && !cb.disabled)                    .map(cb => cb.value);                                if (drawType) {                    drawRecords.push({                        type: drawType,                        tenpaiPlayers: tenpaiPlayers,                        riichiPlayers: riichiPlayers,                        furoPlayers: furoPlayers                    });                }            });                        // 创建游戏对象            const game = {                id: Date.now(),                date: date,                players: players,                rankings: rankings,                winRecords: winRecords,                drawRecords: drawRecords            };                        // 保存到数据            games.push(game);            if (saveData()) {                showDataStatus('对局记录已保存', 'saving');            } else {                showDataStatus('保存失败，请尝试导出备份', 'error');            }                        // 更新界面            renderHistory();            clearForm();            showToast('对局记录已保存');                        // 3秒后隐藏状态消息            setTimeout(() => {                hideDataStatus();            }, 3000);        }                // 清空表单        function clearForm() {            // 不清空玩家和日期，方便连续记录            // document.getElementById('game-date').value = '';            // clearPlayers();                        rankingSelects.forEach(select => {                select.selectedIndex = 0;            });                        winRecordsContainer.innerHTML = '';            drawRecordsContainer.innerHTML = '';                        // 清除错误状态            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));                        showToast('表单已清空');        }                // 渲染历史记录        function renderHistory() {            if (games.length === 0) {                historyList.innerHTML = `                    <div class="empty-state">                        <div class="empty-icon">??</div>                        <p>暂无对局记录</p>                        <p>请在对局记录页添加新的对局</p>                    </div>                `;                return;            }                        historyList.innerHTML = '';                        // 按日期倒序排列            const sortedGames = [...games].sort((a, b) => new Date(b.date) - new Date(a.date));                        sortedGames.forEach(game => {                const gameElement = document.createElement('div');                gameElement.className = 'history-item';                                // 计算和牌记录数量                const winRecordsCount = game.winRecords ? game.winRecords.length : 0;                const drawRecordsCount = game.drawRecords ? game.drawRecords.length : 0;                                gameElement.innerHTML = `                    <div class="history-header">                        <div class="history-date">${formatDate(game.date)}</div>                    </div>                    <div class="history-rankings">                        <div class="ranking-item">                            <div class="ranking-position first">①</div>                            <div>${game.rankings.first}</div>                        </div>                        <div class="ranking-item">                            <div class="ranking-position second">②</div>                            <div>${game.rankings.second}</div>                        </div>                        <div class="ranking-item">                            <div class="ranking-position third">③</div>                            <div>${game.rankings.third}</div>                        </div>                        <div class="ranking-item">                            <div class="ranking-position fourth">④</div>                            <div>${game.rankings.fourth}</div>                        </div>                    </div>                    <div>玩家: ${game.players.join(', ')}</div>                    <div>和牌记录: ${winRecordsCount} 次 | 流局记录: ${drawRecordsCount} 次</div>                `;                                historyList.appendChild(gameElement);            });        }                // 渲染统计数据        function renderStats() {            if (players.length === 0) {                statsContainer.innerHTML = `                    <div class="empty-state">                        <div class="empty-icon">??</div>                        <p>暂无统计数据</p>                        <p>请先在对局记录页添加对局记录</p>                    </div>                `;                return;            }                        statsContainer.innerHTML = '';                        players.forEach(player => {                const playerStats = calculatePlayerStats(player);                const playerCard = document.createElement('div');                playerCard.className = 'player-card';                                playerCard.innerHTML = `                    <div class="player-name">${player}</div>                    <div class="stat-item">                        <div class="stat-label">总局数</div>                        <div class="stat-value">${playerStats.totalGames}</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">平均顺位</div>                        <div class="stat-value">${playerStats.averageRank.toFixed(2)}</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">和牌率</div>                        <div class="stat-value">${(playerStats.winRate * 100).toFixed(1)}%</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">自摸率</div>                        <div class="stat-value">${(playerStats.selfDrawRate * 100).toFixed(1)}%</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">荣和率</div>                        <div class="stat-value">${(playerStats.ronRate * 100).toFixed(1)}%</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">放铳率</div>                        <div class="stat-value">${(playerStats.dealInRate * 100).toFixed(1)}%</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">平均打点</div>                        <div class="stat-value">${playerStats.averagePoints.toFixed(0)}</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">平均放铳点数</div>                        <div class="stat-value">${playerStats.averageDealInPoints.toFixed(0)}</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">立直和牌率</div>                        <div class="stat-value">${(playerStats.riichiWinRate * 100).toFixed(1)}%</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">默听和牌率</div>                        <div class="stat-value">${(playerStats.damatenWinRate * 100).toFixed(1)}%</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">副露和牌率</div>                        <div class="stat-value">${(playerStats.furoWinRate * 100).toFixed(1)}%</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">立直率</div>                        <div class="stat-value">${(playerStats.riichiRate * 100).toFixed(1)}%</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">副露率</div>                        <div class="stat-value">${(playerStats.furoRate * 100).toFixed(1)}%</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">连对率</div>                        <div class="stat-value">${(playerStats.topTwoRate * 100).toFixed(1)}%</div>                    </div>                    <div class="stat-item">                        <div class="stat-label">流局听牌率</div>                        <div class="stat-value">${(playerStats.tenpaiRate * 100).toFixed(1)}%</div>                    </div>                `;                                statsContainer.appendChild(playerCard);            });        }                // 渲染图表        function renderCharts() {            if (players.length === 0) {                document.getElementById('charts').innerHTML = `                    <div class="card">                        <div class="empty-state">                            <div class="empty-icon">??</div>                            <p>暂无统计数据</p>                            <p>请先在对局记录页添加对局记录</p>                        </div>                    </div>                `;                return;            }                        // 准备图表数据            const playerNames = players;            const averageRanks = players.map(player => calculatePlayerStats(player).averageRank);            const winRates = players.map(player => calculatePlayerStats(player).winRate * 100);            const dealInRates = players.map(player => calculatePlayerStats(player).dealInRate * 100);            const averagePoints = players.map(player => calculatePlayerStats(player).averagePoints);                        // 颜色配置            const backgroundColors = [                'rgba(255, 99, 132, 0.7)',                'rgba(54, 162, 235, 0.7)',                'rgba(255, 206, 86, 0.7)',                'rgba(75, 192, 192, 0.7)',                'rgba(153, 102, 255, 0.7)',                'rgba(255, 159, 64, 0.7)'            ];                        const borderColors = [                'rgba(255, 99, 132, 1)',                'rgba(54, 162, 235, 1)',                'rgba(255, 206, 86, 1)',                'rgba(75, 192, 192, 1)',                'rgba(153, 102, 255, 1)',                'rgba(255, 159, 64, 1)'            ];                        // 销毁之前的图表实例            if (averageRankChart) averageRankChart.destroy();            if (winRateChart) winRateChart.destroy();            if (dealInRateChart) dealInRateChart.destroy();            if (averagePointsChart) averagePointsChart.destroy();                        // 平均顺位图表            const averageRankCtx = document.getElementById('average-rank-chart').getContext('2d');            averageRankChart = new Chart(averageRankCtx, {                type: 'bar',                data: {                    labels: playerNames,                    datasets: [{                        label: '平均顺位',                        data: averageRanks,                        backgroundColor: backgroundColors,                        borderColor: borderColors,                        borderWidth: 1                    }]                },                options: {                    scales: {                        y: {                            beginAtZero: false,                            min: 1,                            max: 4,                            reverse: true,                            title: {                                display: true,                                text: '顺位 (1-4)'                            }                        }                    },                    plugins: {                        legend: {                            display: false                        },                        tooltip: {                            callbacks: {                                label: function(context) {                                    return `平均顺位: ${context.parsed.y.toFixed(2)}`;                                }                            }                        }                    }                }            });                        // 和牌率图表            const winRateCtx = document.getElementById('win-rate-chart').getContext('2d');            winRateChart = new Chart(winRateCtx, {                type: 'bar',                data: {                    labels: playerNames,                    datasets: [{                        label: '和牌率 (%)',                        data: winRates,                        backgroundColor: backgroundColors,                        borderColor: borderColors,                        borderWidth: 1                    }]                },                options: {                    scales: {                        y: {                            beginAtZero: true,                            max: 100,                            title: {                                display: true,                                text: '百分比 (%)'                            }                        }                    },                    plugins: {                        legend: {                            display: false                        },                        tooltip: {                            callbacks: {                                label: function(context) {                                    return `和牌率: ${context.parsed.y.toFixed(1)}%`;                                }                            }                        }                    }                }            });                        // 放铳率图表            const dealInRateCtx = document.getElementById('deal-in-rate-chart').getContext('2d');            dealInRateChart = new Chart(dealInRateCtx, {                type: 'bar',                data: {                    labels: playerNames,                    datasets: [{                        label: '放铳率 (%)',                        data: dealInRates,                        backgroundColor: backgroundColors,                        borderColor: borderColors,                        borderWidth: 1                    }]                },                options: {                    scales: {                        y: {                            beginAtZero: true,                            max: 100,                            title: {                                display: true,                                text: '百分比 (%)'                            }                        }                    },                    plugins: {                        legend: {                            display: false                        },                        tooltip: {                            callbacks: {                                label: function(context) {                                    return `放铳率: ${context.parsed.y.toFixed(1)}%`;                                }                            }                        }                    }                }            });                        // 平均打点图表            const averagePointsCtx = document.getElementById('average-points-chart').getContext('2d');            averagePointsChart = new Chart(averagePointsCtx, {                type: 'bar',                data: {                    labels: playerNames,                    datasets: [{                        label: '平均打点',                        data: averagePoints,                        backgroundColor: backgroundColors,                        borderColor: borderColors,                        borderWidth: 1                    }]                },                options: {                    scales: {                        y: {                            beginAtZero: true,                            title: {                                display: true,                                text: '点数'                            }                        }                    },                    plugins: {                        legend: {                            display: false                        },                        tooltip: {                            callbacks: {                                label: function(context) {                                    return `平均打点: ${context.parsed.y.toFixed(0)}`;                                }                            }                        }                    }                }            });        }                // 计算玩家统计数据        function calculatePlayerStats(player) {            const stats = {                totalGames: 0,                totalRanks: 0,                totalWins: 0,                totalSelfDraws: 0,                totalRons: 0,                totalDealIns: 0,                totalPoints: 0,                totalDealInPoints: 0,                totalRiichiWins: 0,                totalDamatenWins: 0,                totalFuroWins: 0,                totalRiichiCount: 0,                totalFuroCount: 0,                totalTopTwo: 0,                totalDraws: 0,                totalTenpai: 0,                totalHands: 0 // 总小局数（和牌记录+流局记录）            };                        games.forEach(game => {                // 检查玩家是否参与此对局                if (!game.players.includes(player)) return;                                stats.totalGames++;                                // 计算顺位                let rank = 0;                if (game.rankings.first === player) {                    rank = 1;                    stats.totalTopTwo++;                } else if (game.rankings.second === player) {                    rank = 2;                    stats.totalTopTwo++;                } else if (game.rankings.third === player) {                    rank = 3;                } else if (game.rankings.fourth === player) {                    rank = 4;                }                                stats.totalRanks += rank;                                // 统计和牌记录                if (game.winRecords) {                    game.winRecords.forEach(record => {                        // 统计和牌                        if (record.winner === player) {                            stats.totalWins++;                            stats.totalPoints += record.points;                                                        if (record.type === '自摸') {                                stats.totalSelfDraws++;                            } else if (record.type === '荣和') {                                stats.totalRons++;                            }                                                        // 统计听牌方式                            if (record.tenpaiType === '立直') {                                stats.totalRiichiWins++;                            } else if (record.tenpaiType === '默听') {                                stats.totalDamatenWins++;                            } else if (record.tenpaiType === '副露听') {                                stats.totalFuroWins++;                            }                        }                                                // 统计放铳                        if (record.loser === player) {                            stats.totalDealIns++;                            stats.totalDealInPoints += record.points;                        }                                                // 统计立直                        if (record.riichiPlayers && record.riichiPlayers.includes(player)) {                            stats.totalRiichiCount++;                        }                                                // 统计副露                        if (record.furoPlayers && record.furoPlayers.includes(player)) {                            stats.totalFuroCount++;                        }                                                // 统计总小局数（和牌记录）                        stats.totalHands++;                    });                }                                // 统计流局记录                if (game.drawRecords) {                    game.drawRecords.forEach(record => {                        // 统计总小局数（流局记录）                        stats.totalHands++;                        stats.totalDraws++;                                                // 统计听牌                        if (record.tenpaiPlayers && record.tenpaiPlayers.includes(player)) {                            stats.totalTenpai++;                        }                                                // 统计立直                        if (record.riichiPlayers && record.riichiPlayers.includes(player)) {                            stats.totalRiichiCount++;                        }                                                // 统计副露                        if (record.furoPlayers && record.furoPlayers.includes(player)) {                            stats.totalFuroCount++;                        }                    });                }            });                        // 计算平均值和比率            return {                totalGames: stats.totalGames,                averageRank: stats.totalGames > 0 ? stats.totalRanks / stats.totalGames : 0,                winRate: stats.totalHands > 0 ? stats.totalWins / stats.totalHands : 0,                selfDrawRate: stats.totalWins > 0 ? stats.totalSelfDraws / stats.totalWins : 0,                ronRate: stats.totalWins > 0 ? stats.totalRons / stats.totalWins : 0,                dealInRate: stats.totalHands > 0 ? stats.totalDealIns / stats.totalHands : 0,                averagePoints: stats.totalWins > 0 ? stats.totalPoints / stats.totalWins : 0,                averageDealInPoints: stats.totalDealIns > 0 ? stats.totalDealInPoints / stats.totalDealIns : 0,                riichiWinRate: stats.totalWins > 0 ? stats.totalRiichiWins / stats.totalWins : 0,                damatenWinRate: stats.totalWins > 0 ? stats.totalDamatenWins / stats.totalWins : 0,                furoWinRate: stats.totalWins > 0 ? stats.totalFuroWins / stats.totalWins : 0,                riichiRate: stats.totalHands > 0 ? stats.totalRiichiCount / stats.totalHands : 0,                furoRate: stats.totalHands > 0 ? stats.totalFuroCount / stats.totalHands : 0,                topTwoRate: stats.totalGames > 0 ? stats.totalTopTwo / stats.totalGames : 0,                tenpaiRate: stats.totalDraws > 0 ? stats.totalTenpai / stats.totalDraws : 0            };        }                // 导出到Excel        function exportToExcel() {            if (games.length === 0) {                showToast('没有数据可导出');                return;            }                        try {                // 创建工作簿                const wb = XLSX.utils.book_new();                                // 对局记录工作表                const gameData = games.map(game => ({                    '日期': game.date,                    '玩家1': game.players[0],                    '玩家2': game.players[1],                    '玩家3': game.players[2],                    '玩家4': game.players[3],                    '一位': game.rankings.first,                    '二位': game.rankings.second,                    '三位': game.rankings.third,                    '四位': game.rankings.fourth                }));                                const gameWs = XLSX.utils.json_to_sheet(gameData);                XLSX.utils.book_append_sheet(wb, gameWs, '对局记录');                                // 和牌记录工作表                const winRecordData = [];                games.forEach(game => {                    if (game.winRecords) {                        game.winRecords.forEach(record => {                            winRecordData.push({                                '对局日期': game.date,                                '和牌类型': record.type,                                '听牌方式': record.tenpaiType,                                '和牌者': record.winner,                                '放铳者': record.loser || '无',                                '点数': record.points,                                '立直玩家': record.riichiPlayers.join(', '),                                '副露玩家': record.furoPlayers.join(', ')                            });                        });                    }                });                                if (winRecordData.length > 0) {                    const winRecordWs = XLSX.utils.json_to_sheet(winRecordData);                    XLSX.utils.book_append_sheet(wb, winRecordWs, '和牌记录');                }                                // 流局记录工作表                const drawRecordData = [];                games.forEach(game => {                    if (game.drawRecords) {                        game.drawRecords.forEach(record => {                            drawRecordData.push({                                '对局日期': game.date,                                '流局类型': record.type,                                '听牌玩家': record.tenpaiPlayers.join(', '),                                '立直玩家': record.riichiPlayers.join(', '),                                '副露玩家': record.furoPlayers.join(', ')                            });                        });                    }                });                                if (drawRecordData.length > 0) {                    const drawRecordWs = XLSX.utils.json_to_sheet(drawRecordData);                    XLSX.utils.book_append_sheet(wb, drawRecordWs, '流局记录');                }                                // 玩家统计工作表                const playerStatsData = players.map(player => {                    const stats = calculatePlayerStats(player);                    return {                        '玩家': player,                        '总局数': stats.totalGames,                        '平均顺位': stats.averageRank.toFixed(2),                        '和牌率': (stats.winRate * 100).toFixed(1) + '%',                        '自摸率': (stats.selfDrawRate * 100).toFixed(1) + '%',                        '荣和率': (stats.ronRate * 100).toFixed(1) + '%',                        '放铳率': (stats.dealInRate * 100).toFixed(1) + '%',                        '平均打点': stats.averagePoints.toFixed(0),                        '平均放铳点数': stats.averageDealInPoints.toFixed(0),                        '立直和牌率': (stats.riichiWinRate * 100).toFixed(1) + '%',                        '默听和牌率': (stats.damatenWinRate * 100).toFixed(1) + '%',                        '副露和牌率': (stats.furoWinRate * 100).toFixed(1) + '%',                        '立直率': (stats.riichiRate * 100).toFixed(1) + '%',                        '副露率': (stats.furoRate * 100).toFixed(1) + '%',                        '连对率': (stats.topTwoRate * 100).toFixed(1) + '%',                        '流局听牌率': (stats.tenpaiRate * 100).toFixed(1) + '%'                    };                });                                const playerStatsWs = XLSX.utils.json_to_sheet(playerStatsData);                XLSX.utils.book_append_sheet(wb, playerStatsWs, '玩家统计');                                // 导出文件                XLSX.writeFile(wb, '日麻数据统计.xlsx');                showToast('Excel导出成功');            } catch (error) {                console.error('导出Excel失败:', error);                showToast('导出失败，请重试');            }        }                // 导出到JSON        function exportToJSON() {            if (games.length === 0) {                showToast('没有数据可导出');                return;            }                        const dataStr = JSON.stringify(games, null, 2);            const dataBlob = new Blob([dataStr], {type: 'application/json'});                        const link = document.createElement('a');            link.href = URL.createObjectURL(dataBlob);            link.download = '日麻数据备份.json';            link.click();                        showToast('JSON导出成功');        }                // 从JSON导入        function importFromJSON() {            const input = document.createElement('input');            input.type = 'file';            input.accept = '.json';                        input.onchange = function(event) {                const file = event.target.files[0];                if (!file) return;                                const reader = new FileReader();                reader.onload = function(e) {                    try {                        const importedGames = JSON.parse(e.target.result);                                                if (Array.isArray(importedGames) && importedGames.length > 0) {                            // 验证数据结构                            const isValid = importedGames.every(game =>                                 game.date && game.players && game.rankings                            );                                                        if (isValid) {                                games = importedGames;                                saveData();                                renderHistory();                                renderStats();                                showToast('数据导入成功');                            } else {                                showToast('文件格式不正确');                            }                        } else {                            showToast('文件内容为空或格式不正确');                        }                    } catch (error) {                        console.error('导入JSON失败:', error);                        showToast('导入失败，请检查文件格式');                    }                };                                reader.readAsText(file);            };                        input.click();        }                // 清空所有数据        function clearAllData() {            if (confirm('确定要清空所有数据吗？此操作不可恢复！')) {                games = [];                players = [];                saveData();                renderHistory();                renderStats();                showToast('所有数据已清空');            }        }                // 显示提示消息        function showToast(message) {            toast.textContent = message;            toast.classList.add('show');                        setTimeout(() => {                toast.classList.remove('show');            }, 3000);        }                // 格式化日期        function formatDate(dateString) {            const date = new Date(dateString);            return `${date.getMonth() + 1}月${date.getDate()}日`;        }    </script></body></html>