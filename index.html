<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥éº»æˆ˜ç»©ç»Ÿè®¡ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --bg-color: #f5f7fa;
            --card-bg: white;
            --text-color: #333;
            --border-color: #ddd;
        }

        .theme-dark {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #444;
            --light-color: #3d3d3d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .card-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: var(--text-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--light-color);
            font-weight: bold;
        }
        
        tr:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }
        
        .theme-dark tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .player-card {
            background: var(--light-color);
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
        }
        
        .player-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .player-stats {
            font-size: 0.9rem;
            color: #666;
        }
        
        .theme-dark .player-stats {
            color: #aaa;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .theme-dark .stat-label {
            color: #aaa;
        }
        
        .position-1 { color: #e74c3c; font-weight: bold; }
        .position-2 { color: #e67e22; font-weight: bold; }
        .position-3 { color: #f39c12; font-weight: bold; }
        .position-4 { color: #3498db; font-weight: bold; }
        
        .rate-bars {
            display: flex;
            height: 20px;
            margin: 5px 0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .rate-1 { background-color: #e74c3c; }
        .rate-2 { background-color: #e67e22; }
        .rate-3 { background-color: #f39c12; }
        .rate-4 { background-color: #3498db; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .player-list, .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æ—¥éº»æˆ˜ç»©ç»Ÿè®¡ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</h1>
            <p class="subtitle">è®°å½•ã€åˆ†æã€æå‡ä½ çš„æ—¥éº»æˆ˜ç»©</p>
        </header>
        
        <button class="theme-toggle" id="theme-toggle">ğŸŒ™</button>
        
        <div class="tabs">
            <div class="tab active" data-tab="record">æˆ˜ç»©è®°å½•</div>
            <div class="tab" data-tab="view">æ•°æ®æŸ¥çœ‹</div>
            <div class="tab" data-tab="players">ç©å®¶ç»Ÿè®¡</div>
            <div class="tab" data-tab="export">å¯¼å…¥/å¯¼å‡º</div>
        </div>
        
        <!-- æˆ˜ç»©è®°å½•æ ‡ç­¾é¡µ -->
        <div class="tab-content active" id="record-tab">
            <div class="card">
                <h2 class="card-title">æ–°å¢å¯¹å±€è®°å½•</h2>
                <form id="game-form">
                    <div class="form-group">
                        <label for="game-date">æ¯”èµ›æ—¥æœŸ</label>
                        <input type="date" id="game-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="game-type">æ¯”èµ›å½¢å¼</label>
                        <select id="game-type" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="ä¸ªäººæˆ˜">ä¸ªäººæˆ˜</option>
                            <option value="ç»ƒä¹ èµ›">ç»ƒä¹ èµ›</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="game-format">å±€åˆ¶</label>
                        <select id="game-format" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="ä¸œé£æˆ˜">ä¸œé£æˆ˜</option>
                            <option value="åŠåº„æˆ˜">åŠåº„æˆ˜</option>
                        </select>
                    </div>
                    
                    <h3 class="card-title">ç©å®¶ä¿¡æ¯</h3>
                    
                    <div class="form-group">
                        <label>ç©å®¶1 (1ä½)</label>
                        <select class="player-select" data-position="1" required>
                            <option value="">è¯·é€‰æ‹©ç©å®¶</option>
                        </select>
                        <input type="number" class="player-score" data-position="1" placeholder="æœ€ç»ˆåˆ†æ•°" min="-100000" max="200000" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ç©å®¶2 (2ä½)</label>
                        <select class="player-select" data-position="2" required>
                            <option value="">è¯·é€‰æ‹©ç©å®¶</option>
                        </select>
                        <input type="number" class="player-score" data-position="2" placeholder="æœ€ç»ˆåˆ†æ•°" min="-100000" max="200000" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ç©å®¶3 (3ä½)</label>
                        <select class="player-select" data-position="3" required>
                            <option value="">è¯·é€‰æ‹©ç©å®¶</option>
                        </select>
                        <input type="number" class="player-score" data-position="3" placeholder="æœ€ç»ˆåˆ†æ•°" min="-100000" max="200000" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ç©å®¶4 (4ä½)</label>
                        <select class="player-select" data-position="4" required>
                            <option value="">è¯·é€‰æ‹©ç©å®¶</option>
                        </select>
                        <input type="number" class="player-score" data-position="4" placeholder="æœ€ç»ˆåˆ†æ•°" min="-100000" max="200000" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="game-notes">å¯¹å±€åˆ†æ/å¤‡æ³¨</label>
                        <textarea id="game-notes" placeholder="è®°å½•æœ¬å±€çš„å…³é”®ç‚¹ã€ç²¾å½©æ“ä½œæˆ–å¤ç›˜åˆ†æ..."></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button type="submit" class="btn-success">ä¿å­˜è®°å½•</button>
                        <button type="reset" class="btn-danger">é‡ç½®è¡¨å•</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- æ•°æ®æŸ¥çœ‹æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="view-tab">
            <div class="card">
                <h2 class="card-title">æ‰€æœ‰å¯¹å±€è®°å½•</h2>
                <table id="games-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>å½¢å¼</th>
                            <th>å±€åˆ¶</th>
                            <th>1ä½ (ç§¯åˆ†)</th>
                            <th>2ä½ (ç§¯åˆ†)</th>
                            <th>3ä½ (ç§¯åˆ†)</th>
                            <th>4ä½ (ç§¯åˆ†)</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="games-list">
                        <!-- æ¸¸æˆè®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ç©å®¶ç»Ÿè®¡æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="players-tab">
            <div class="card">
                <h2 class="card-title">ç©å®¶ç»Ÿè®¡æ¦‚è§ˆ</h2>
                <div class="player-list" id="players-stats">
                    <!-- ç©å®¶ç»Ÿè®¡å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">è¯¦ç»†ç»Ÿè®¡æ•°æ®</h2>
                <div class="stats-grid" id="detailed-stats">
                    <!-- è¯¦ç»†ç»Ÿè®¡æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>
        
        <!-- å¯¼å…¥/å¯¼å‡ºæ ‡ç­¾é¡µ -->
        <div class="tab-content" id="export-tab">
            <div class="card">
                <h2 class="card-title">æ•°æ®å¯¼å…¥/å¯¼å‡º</h2>
                <p>ä½¿ç”¨ä»¥ä¸‹åŠŸèƒ½å¤‡ä»½æ‚¨çš„æ•°æ®æˆ–ä¸ä»–äººå…±äº«ã€‚</p>
                
                <div class="btn-group">
                    <button id="export-excel" class="btn-success">å¯¼å‡ºExcelæ–‡ä»¶</button>
                    <button id="import-excel" class="btn-warning">å¯¼å…¥Excelæ–‡ä»¶</button>
                    <button id="export-json" class="btn-success">å¯¼å‡ºJSONæ•°æ®</button>
                    <button id="import-json" class="btn-warning">å¯¼å…¥JSONæ•°æ®</button>
                    <button id="clear-data" class="btn-danger">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="import-file">é€‰æ‹©å¯¼å…¥æ–‡ä»¶</label>
                    <input type="file" id="import-file" accept=".xlsx,.xls,.json" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¹å±€è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="game-detail-modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <h2 class="modal-title">å¯¹å±€è¯¦æƒ…</h2>
            <div id="game-detail-content">
                <!-- å¯¹å±€è¯¦æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
        </div>
    </div>

    <script>
        // ç©å®¶åå•
        let players = JSON.parse(localStorage.getItem('mahjongPlayers')) || [
            "å¼ é”¦è½©", "é‚“æ´‹", "å¯»æ¥å‘", "æ˜“æ ¹ç²", "é»„è‹¥é›¯", 
            "é»„ç›¸é˜³", "é»„é›¨éœ²", "å¼ æ°æ–Œ", "å‘¨ç›¼", "èƒ¡é”¦é¸¿"
        ];

        // ç§¯åˆ†è®¡ç®—è§„åˆ™
        const positionPoints = {
            1: 40,
            2: 20,
            3: -10,
            4: -30
        };

        // å­˜å‚¨æ¸¸æˆè®°å½•
        let gameRecords = JSON.parse(localStorage.getItem('mahjongRecords')) || [];
        
        // ä¸»é¢˜è®¾ç½®
        let themeSettings = JSON.parse(localStorage.getItem('mahjongTheme')) || {
            darkMode: false
        };

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            initializePlayerSelects();
            loadGameRecords();
            updatePlayerStats();
            setupEventListeners();
        });

        // åˆå§‹åŒ–ä¸»é¢˜
        function initializeTheme() {
            if (themeSettings.darkMode) {
                document.body.classList.add('theme-dark');
                document.getElementById('theme-toggle').textContent = 'â˜€ï¸';
            } else {
                document.body.classList.remove('theme-dark');
                document.getElementById('theme-toggle').textContent = 'ğŸŒ™';
            }
        }

        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            themeSettings.darkMode = !themeSettings.darkMode;
            localStorage.setItem('mahjongTheme', JSON.stringify(themeSettings));
            initializeTheme();
        }

        // åˆå§‹åŒ–ç©å®¶é€‰æ‹©ä¸‹æ‹‰æ¡†
        function initializePlayerSelects() {
            const playerSelects = document.querySelectorAll('.player-select');
            playerSelects.forEach(select => {
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªï¼‰
                while(select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // æ·»åŠ ç©å®¶é€‰é¡¹
                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player;
                    option.textContent = player;
                    select.appendChild(option);
                });
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ä¸»é¢˜åˆ‡æ¢
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // æ›´æ–°æ´»è·ƒæ ‡ç­¾
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // æ›´æ–°æ´»è·ƒå†…å®¹
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // è¡¨å•æäº¤
            document.getElementById('game-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveGameRecord();
            });
            
            // å¯¼å‡ºExcel
            document.getElementById('export-excel').addEventListener('click', exportToExcel);
            
            // å¯¼å…¥Excel
            document.getElementById('import-excel').addEventListener('click', function() {
                document.getElementById('import-file').click();
            });
            
            // å¯¼å‡ºJSON
            document.getElementById('export-json').addEventListener('click', exportToJSON);
            
            // å¯¼å…¥JSON
            document.getElementById('import-json').addEventListener('click', function() {
                document.getElementById('import-file').click();
            });
            
            // æ¸…ç©ºæ•°æ®
            document.getElementById('clear-data').addEventListener('click', clearAllData);
            
            // æ–‡ä»¶å¯¼å…¥
            document.getElementById('import-file').addEventListener('change', handleFileImport);
            
            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('close-modal').addEventListener('click', function() {
                document.getElementById('game-detail-modal').style.display = 'none';
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(e) {
                const modal = document.getElementById('game-detail-modal');
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // ä¿å­˜æ¸¸æˆè®°å½•ï¼ˆåŒ…å«æ•°æ®æ ¡éªŒï¼‰
        function saveGameRecord() {
            const gameDate = document.getElementById('game-date').value;
            const gameType = document.getElementById('game-type').value;
            const gameFormat = document.getElementById('game-format').value;
            const gameNotes = document.getElementById('game-notes').value;
            
            // è·å–ç©å®¶å’Œåˆ†æ•°
            const playersInGame = [];
            const scores = [];
            
            for (let i = 1; i <= 4; i++) {
                const playerSelect = document.querySelector(`.player-select[data-position="${i}"]`);
                const scoreInput = document.querySelector(`.player-score[data-position="${i}"]`);
                
                playersInGame.push(playerSelect.value);
                scores.push(parseInt(scoreInput.value));
            }
            
            // æ•°æ®æ ¡éªŒï¼šæ€»åˆ†å¿…é¡»ä¸º100000
            const totalScore = scores.reduce((sum, score) => sum + score, 0);
            if (totalScore !== 100000) {
                alert(`é”™è¯¯ï¼šå››ä½ç©å®¶åˆ†æ•°æ€»å’Œå¿…é¡»ä¸º100000ï¼Œå½“å‰æ€»å’Œä¸º${totalScore}ï¼Œè¯·æ£€æŸ¥è¾“å…¥ï¼`);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤ç©å®¶
            if (new Set(playersInGame).size !== 4) {
                alert('ä¸€å±€æ¸¸æˆä¸­ä¸èƒ½æœ‰é‡å¤ç©å®¶ï¼');
                return;
            }
            
            // åˆ›å»ºè®°å½•å¯¹è±¡
            const record = {
                id: Date.now(),
                date: gameDate,
                type: gameType,
                format: gameFormat,
                notes: gameNotes,
                players: playersInGame,
                scores: scores
            };
            
            // æ·»åŠ åˆ°è®°å½•æ•°ç»„
            gameRecords.push(record);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('mahjongRecords', JSON.stringify(gameRecords));
            
            // é‡æ–°åŠ è½½è®°å½•å’Œç»Ÿè®¡
            loadGameRecords();
            updatePlayerStats();
            
            // é‡ç½®è¡¨å•
            document.getElementById('game-form').reset();
            
            alert('å¯¹å±€è®°å½•ä¿å­˜æˆåŠŸï¼');
        }

        // åŠ è½½æ¸¸æˆè®°å½•
        function loadGameRecords() {
            const gamesList = document.getElementById('games-list');
            gamesList.innerHTML = '';
            
            if (gameRecords.length === 0) {
                gamesList.innerHTML = '<tr><td colspan="8" style="text-align: center;">æš‚æ— å¯¹å±€è®°å½•</td></tr>';
                return;
            }
            
            // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
            const sortedRecords = [...gameRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // è®¡ç®—æ’åå’Œç§¯åˆ†
                const rankedPlayers = [...record.players]
                    .map((player, index) => ({ 
                        player, 
                        score: record.scores[index],
                        positionPoint: 0,
                        scorePoint: 0,
                        totalPoints: 0
                    }))
                    .sort((a, b) => b.score - a.score)
                    .map((item, index) => {
                        const position = index + 1;
                        const positionPoint = positionPoints[position];
                        const scorePoint = (item.score - 30000) / 1000;
                        const totalPoints = positionPoint + scorePoint;
                        
                        return { 
                            ...item, 
                            position: position,
                            positionPoint: positionPoint,
                            scorePoint: scorePoint.toFixed(2),
                            totalPoints: totalPoints.toFixed(2)
                        };
                    });
                
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.type}</td>
                    <td>${record.format}</td>
                    <td><span class="position-1">${rankedPlayers[0].player}</span> (${rankedPlayers[0].totalPoints})</td>
                    <td><span class="position-2">${rankedPlayers[1].player}</span> (${rankedPlayers[1].totalPoints})</td>
                    <td><span class="position-3">${rankedPlayers[2].player}</span> (${rankedPlayers[2].totalPoints})</td>
                    <td><span class="position-4">${rankedPlayers[3].player}</span> (${rankedPlayers[3].totalPoints})</td>
                    <td>
                        <button class="btn-success view-record" data-id="${record.id}">è¯¦æƒ…</button>
                        <button class="btn-danger delete-record" data-id="${record.id}">åˆ é™¤</button>
                    </td>
                `;
                
                gamesList.appendChild(row);
            });
            
            // æ·»åŠ æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.view-record').forEach(button => {
                button.addEventListener('click', function() {
                    const recordId = parseInt(this.getAttribute('data-id'));
                    showRecordDetails(recordId);
                });
            });
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.delete-record').forEach(button => {
                button.addEventListener('click', function() {
                    const recordId = parseInt(this.getAttribute('data-id'));
                    deleteRecord(recordId);
                });
            });
        }

        // æ˜¾ç¤ºè®°å½•è¯¦æƒ…
        function showRecordDetails(recordId) {
            const record = gameRecords.find(r => r.id === recordId);
            if (!record) return;
            
            // è®¡ç®—æ’åå’Œç§¯åˆ†
            const rankedPlayers = [...record.players]
                .map((player, index) => ({ 
                    player, 
                    score: record.scores[index],
                    positionPoint: 0,
                    scorePoint: 0,
                    totalPoints: 0
                }))
                .sort((a, b) => b.score - a.score)
                .map((item, index) => {
                    const position = index + 1;
                    const positionPoint = positionPoints[position];
                    const scorePoint = (item.score - 30000) / 1000;
                    const totalPoints = positionPoint + scorePoint;
                    
                    return { 
                        ...item, 
                        position: position,
                        positionPoint: positionPoint,
                        scorePoint: scorePoint.toFixed(2),
                        totalPoints: totalPoints.toFixed(2)
                    };
                });
            
            let detailsHTML = `
                <p><strong>æ—¥æœŸ:</strong> ${record.date}</p>
                <p><strong>å½¢å¼:</strong> ${record.type}</p>
                <p><strong>å±€åˆ¶:</strong> ${record.format}</p>
                <h3>ç©å®¶æˆç»©</h3>
                <table>
                    <thead>
                        <tr>
                            <th>é¡ºä½</th>
                            <th>ç©å®¶</th>
                            <th>åˆ†æ•°</th>
                            <th>é¡ºä½ç§¯åˆ†</th>
                            <th>ç‚¹æ•°ç§¯åˆ†</th>
                            <th>æ€»ç§¯åˆ†</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            rankedPlayers.forEach(player => {
                detailsHTML += `
                    <tr>
                        <td><span class="position-${player.position}">${player.position}ä½</span></td>
                        <td>${player.player}</td>
                        <td>${player.score}</td>
                        <td>${player.positionPoint}</td>
                        <td>${player.scorePoint}</td>
                        <td>${player.totalPoints}</td>
                    </tr>
                `;
            });
            
            detailsHTML += `
                    </tbody>
                </table>
            `;
            
            if (record.notes) {
                detailsHTML += `<h3>å¯¹å±€åˆ†æ/å¤‡æ³¨</h3><p>${record.notes}</p>`;
            }
            
            document.getElementById('game-detail-content').innerHTML = detailsHTML;
            document.getElementById('game-detail-modal').style.display = 'flex';
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(recordId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                gameRecords = gameRecords.filter(record => record.id !== recordId);
                localStorage.setItem('mahjongRecords', JSON.stringify(gameRecords));
                loadGameRecords();
                updatePlayerStats();
            }
        }

        // æ›´æ–°ç©å®¶ç»Ÿè®¡
        function updatePlayerStats() {
            updatePlayerCards();
            updateDetailedStats();
        }

        // æ›´æ–°ç©å®¶å¡ç‰‡
        function updatePlayerCards() {
            const playersStats = document.getElementById('players-stats');
            playersStats.innerHTML = '';
            
            players.forEach(player => {
                const playerRecords = getPlayerRecords(player);
                const stats = calculatePlayerStats(player, playerRecords);
                
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                
                playerCard.innerHTML = `
                    <div class="player-name">${player}</div>
                    <div class="player-stats">
                        <div>å¯¹å±€æ•°: ${stats.totalGames}</div>
                        <div>æ€»ç§¯åˆ†: ${stats.totalPoints.toFixed(2)}</div>
                        <div>å¹³å‡é¡ºä½: ${stats.averagePosition.toFixed(2)}</div>
                        <div>å¹³å‡ç§¯åˆ†: ${stats.averagePoints.toFixed(2)}</div>
                        <div>ä¸€ä½ç‡: ${(stats.positionRates[0] * 100).toFixed(1)}%</div>
                    </div>
                `;
                
                playersStats.appendChild(playerCard);
            });
        }

        // æ›´æ–°è¯¦ç»†ç»Ÿè®¡
        function updateDetailedStats() {
            const detailedStats = document.getElementById('detailed-stats');
            detailedStats.innerHTML = '';
            
            // æ€»ä½“ç»Ÿè®¡
            const totalStats = calculateTotalStats();
            
            const statsCards = [
                { label: 'æ€»å¯¹å±€æ•°', value: totalStats.totalGames, highlight: false },
                { label: 'æœ€å¤šä¸€ä½', value: totalStats.mostFirstPlace, highlight: true },
                { label: 'æœ€é«˜å¹³å‡ç§¯åˆ†', value: totalStats.highestAvgPoints, highlight: true },
                { label: 'æœ€ä½³å¹³å‡é¡ºä½', value: totalStats.bestAvgPosition, highlight: true }
            ];
            
            statsCards.forEach(card => {
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                
                statCard.innerHTML = `
                    <div class="stat-label">${card.label}</div>
                    <div class="stat-value ${card.highlight ? 'highlight' : ''}">${card.value}</div>
                `;
                
                detailedStats.appendChild(statCard);
            });
        }

        // è·å–ç©å®¶è®°å½•
        function getPlayerRecords(playerName) {
            return gameRecords.filter(record => 
                record.players.includes(playerName)
            ).map(record => {
                const playerIndex = record.players.indexOf(playerName);
                const score = record.scores[playerIndex];
                
                // è®¡ç®—æ’å
                const rankedPlayers = [...record.players]
                    .map((p, i) => ({ player: p, score: record.scores[i] }))
                    .sort((a, b) => b.score - a.score);
                
                const position = rankedPlayers.findIndex(p => p.player === playerName) + 1;
                
                // è®¡ç®—ç§¯åˆ†
                const positionPoint = positionPoints[position];
                const scorePoint = (score - 30000) / 1000;
                const totalPoints = positionPoint + scorePoint;
                
                return {
                    date: record.date,
                    type: record.type,
                    format: record.format,
                    position: position,
                    score: score,
                    points: totalPoints
                };
            });
        }

        // è®¡ç®—ç©å®¶ç»Ÿè®¡
        function calculatePlayerStats(playerName, playerRecords) {
            if (playerRecords.length === 0) {
                return {
                    totalGames: 0,
                    totalPoints: 0,
                    averagePosition: 0,
                    averagePoints: 0,
                    positionCounts: [0, 0, 0, 0],
                    positionRates: [0, 0, 0, 0]
                };
            }
            
            const totalGames = playerRecords.length;
            const totalPosition = playerRecords.reduce((sum, record) => sum + record.position, 0);
            const totalPoints = playerRecords.reduce((sum, record) => sum + record.points, 0);
            
            // è®¡ç®—å„é¡ºä½æ¬¡æ•°
            const positionCounts = [0, 0, 0, 0];
            playerRecords.forEach(record => {
                positionCounts[record.position - 1]++;
            });
            
            // è®¡ç®—å„é¡ºä½æ¯”ç‡
            const positionRates = positionCounts.map(count => count / totalGames);
            
            return {
                totalGames: totalGames,
                totalPoints: totalPoints,
                averagePosition: totalPosition / totalGames,
                averagePoints: totalPoints / totalGames,
                positionCounts: positionCounts,
                positionRates: positionRates
            };
        }

        // è®¡ç®—æ€»ä½“ç»Ÿè®¡
        function calculateTotalStats() {
            let mostFirstPlace = { player: '', count: 0 };
            let highestAvgPoints = { player: '', value: -Infinity };
            let bestAvgPosition = { player: '', value: Infinity };
            
            players.forEach(player => {
                const playerRecords = getPlayerRecords(player);
                if (playerRecords.length === 0) return;
                
                const stats = calculatePlayerStats(player, playerRecords);
                const firstPlaceCount = stats.positionCounts[0];
                
                if (firstPlaceCount > mostFirstPlace.count) {
                    mostFirstPlace = { player: player, count: firstPlaceCount };
                }
                
                if (stats.averagePoints > highestAvgPoints.value) {
                    highestAvgPoints = { player: player, value: stats.averagePoints };
                }
                
                if (stats.averagePosition < bestAvgPosition.value) {
                    bestAvgPosition = { player: player, value: stats.averagePosition };
                }
            });
            
            return {
                totalGames: gameRecords.length,
                mostFirstPlace: mostFirstPlace.player ? `${mostFirstPlace.player} (${mostFirstPlace.count}æ¬¡)` : 'æ— æ•°æ®',
                highestAvgPoints: highestAvgPoints.player ? `${highestAvgPoints.player} (${highestAvgPoints.value.toFixed(2)})` : 'æ— æ•°æ®',
                bestAvgPosition: bestAvgPosition.player ? `${bestAvgPosition.player} (${bestAvgPosition.value.toFixed(2)})` : 'æ— æ•°æ®'
            };
        }

        // å¯¼å‡ºåˆ°Excel
        function exportToExcel() {
            if (gameRecords.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            
            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            
            // åˆ›å»ºæ€»æˆ˜ç»©è®°å½•è¡¨
            const totalData = [['æ¯”èµ›æ—¥æœŸ', 'æ¯”èµ›å½¢å¼', 'å±€åˆ¶', 'ç©å®¶1', 'ç©å®¶1åˆ†æ•°', 'ç©å®¶2', 'ç©å®¶2åˆ†æ•°', 'ç©å®¶3', 'ç©å®¶3åˆ†æ•°', 'ç©å®¶4', 'ç©å®¶4åˆ†æ•°', 'å¯¹å±€åˆ†æ']];
            
            gameRecords.forEach(record => {
                totalData.push([
                    record.date,
                    record.type,
                    record.format,
                    record.players[0],
                    record.scores[0],
                    record.players[1],
                    record.scores[1],
                    record.players[2],
                    record.scores[2],
                    record.players[3],
                    record.scores[3],
                    record.notes || ''
                ]);
            });
            
            const totalSheet = XLSX.utils.aoa_to_sheet(totalData);
            XLSX.utils.book_append_sheet(wb, totalSheet, 'æ€»æˆ˜ç»©è®°å½•');
            
            // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `æ—¥éº»æˆ˜ç»©ç»Ÿè®¡_${today}.xlsx`);
        }

        // å¯¼å‡ºåˆ°JSON
        function exportToJSON() {
            if (gameRecords.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            
            const exportData = {
                records: gameRecords,
                players: players,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `æ—¥éº»æˆ˜ç»©ç»Ÿè®¡_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        function handleFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let importedData;
                    
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(e.target.result);
                        importedData = data.records || data;
                    } else {
                        // å¤„ç†Excelæ–‡ä»¶
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // è¯»å–æ€»æˆ˜ç»©è®°å½•è¡¨
                        const totalSheet = workbook.Sheets['æ€»æˆ˜ç»©è®°å½•'];
                        if (!totalSheet) {
                            throw new Error('Excelæ–‡ä»¶ä¸­æœªæ‰¾åˆ°"æ€»æˆ˜ç»©è®°å½•"å·¥ä½œè¡¨');
                        }
                        
                        const totalData = XLSX.utils.sheet_to_json(totalSheet, {header: 1});
                        // è·³è¿‡æ ‡é¢˜è¡Œ
                        totalData.shift();
                        
                        importedData = [];
                        totalData.forEach(row => {
                            if (row.length >= 11) {
                                const record = {
                                    id: Date.now() + Math.random(),
                                    date: row[0],
                                    type: row[1],
                                    format: row[2],
                                    players: [row[3], row[5], row[7], row[9]],
                                    scores: [row[4], row[6], row[8], row[10]],
                                    notes: row[11] || ''
                                };
                                importedData.push(record);
                            }
                        });
                    }
                    
                    // éªŒè¯å¯¼å…¥çš„æ•°æ®
                    if (!Array.isArray(importedData)) {
                        throw new Error('å¯¼å…¥çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }
                    
                    // åˆå¹¶æ•°æ®
                    gameRecords = [...gameRecords, ...importedData];
                    localStorage.setItem('mahjongRecords', JSON.stringify(gameRecords));
                    
                    // æ›´æ–°ç•Œé¢
                    loadGameRecords();
                    updatePlayerStats();
                    
                    alert(`æˆåŠŸå¯¼å…¥ ${importedData.length} æ¡è®°å½•ï¼`);
                    
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥: ' + error.message);
                }
            };
            
            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            e.target.value = '';
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                gameRecords = [];
                localStorage.setItem('mahjongRecords', JSON.stringify(gameRecords));
                loadGameRecords();
                updatePlayerStats();
                alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
            }
        }
    </script>
</body>
</html>
